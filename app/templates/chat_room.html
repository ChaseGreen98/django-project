{% extends "root.html" %}

{% block content %}
<div class="chat-room-container" style="max-width:800px; margin:auto; display:flex; flex-direction:column; gap:1rem;">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Chat Room: {{ conversation.subject }}</h2>
        <a href="{% url 'social' %}"><button>Leave Room</button></a>
    </div>

    <!-- Chat Log -->
    <div id="chat-log" style="border:1px solid #ccc; padding:0.5rem; height:400px; overflow-y:scroll; font-family:monospace;">
        {% for message in messages %}
            <div>[{{ message.timestamp|date:"Y-m-d H:i" }}] {{ message.sender.username }}: {{ message.content }}</div>
        {% endfor %}
    </div>

    <!-- Input -->
    <div style="display:flex; gap:0.5rem;">
        <input id="chat-message-input" type="text" placeholder="Type your message..." style="flex:1; padding:0.5rem;">
        <button id="chat-message-submit">Send</button>
    </div>

</div>

<script>
const conversationId = "{{ conversation.id }}";
const username = "{{ user.username }}";

const chatLog = document.getElementById("chat-log");
const input = document.getElementById("chat-message-input");
const submit = document.getElementById("chat-message-submit");

const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + conversationId + "/");

// Append a message to chat log
function addMessage(username, message, timestamp) {
    const line = document.createElement("div");
    line.textContent = `[${timestamp}] ${username}: ${message}`;
    chatLog.appendChild(line);
    chatLog.scrollTop = chatLog.scrollHeight;
}

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === "history") {
        data.messages.forEach(msg => addMessage(msg.username, msg.content, msg.timestamp));
    }
    if (data.type === "message") {
        addMessage(data.username, data.message, data.timestamp);
    }
};

submit.onclick = function() {
    const message = input.value.trim();
    if (!message) return;

    socket.send(JSON.stringify({ message, username }));
    input.value = "";
};

input.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        submit.click();
    }
});
</script>
{% endblock %}
