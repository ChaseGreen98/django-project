{% extends "root.html" %}

{% block content %}
<div class="chat-window">

    <div class="chat-header">
        <h2>Chat Room: {{ conversation.subject }}</h2>
        <a href="{% url 'social' %}"><button class="chat-leave-button">Leave Room</button></a>
    </div>

    <div id="chat-log" class="chat-log">
        {% for message in messages %}
            <div class="chat-message">
                [{{ message.timestamp|date:"Y-m-d H:i" }}] {{ message.sender.username }}: {{ message.content }}
            </div>
        {% endfor %}
    </div>

    <div class="chat-input-container">
        <input id="chat-message-input" type="text" placeholder="Type your message..." class="chat-input">
        <button id="chat-message-submit" class="chat-send-button">Send</button>
    </div>

</div>

<script>
const conversationId = "{{ conversation.id }}";
const username = "{{ user.username }}";

const chatLog = document.getElementById("chat-log");
const input = document.getElementById("chat-message-input");
const submit = document.getElementById("chat-message-submit");

const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + conversationId + "/");

function addMessage(username, message, timestamp) {
    const line = document.createElement("div");
    line.textContent = `[${timestamp}] ${username}: ${message}`;
    line.classList.add("chat-message");
    chatLog.appendChild(line);
    chatLog.scrollTop = chatLog.scrollHeight;
}

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === "history") {
        data.messages.forEach(msg => addMessage(msg.username, msg.content, msg.timestamp));
    }
    if (data.type === "message") {
        addMessage(data.username, data.message, data.timestamp);
    }
};

submit.onclick = function() {
    const message = input.value.trim();
    if (!message) return;

    socket.send(JSON.stringify({ message, username }));
    input.value = "";
};

input.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        submit.click();
    }
});
</script>
{% endblock %}
